{% extends 'dashboard_base.html' %}

{% block dashboard_content %}
    {% if not company %}
        <h2 class="text-3xl font-bold text-center text-secondary mb-8">Cadastrar sua Empresa</h2>
        <p class="text-center text-gray-600 mb-8">Preencha as informações abaixo. Após o envio, seus dados passarão por uma análise.</p>
        {% include 'company_management/company_form.html' %}
    
    {% elif edit_mode %}
        <h2 class="text-3xl font-bold text-center text-secondary mb-8">Solicitar Alteração de Dados</h2>
        <p class="text-center text-gray-600 mb-8">Modifique os campos desejados. Sua solicitação será enviada para análise.</p>
        {% include 'company_management/company_form.html' %}

    {% else %}
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-secondary">Dados da sua Empresa</h2>
            {% if company.status == 'ACTIVE' %}
            <a href="?edit=true" class="bg-accent text-secondary font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">
                Solicitar Alteração
            </a>
            {% endif %}
        </div>
        
        <div class="space-y-8">
            <!-- Dados Empresariais -->
            <div>
                <h3 class="text-xl font-semibold text-secondary border-b pb-2 mb-4">Dados Empresariais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p><strong>Status:</strong> {{ company.get_status_display }}</p>
                    <p><strong>Razão Social:</strong> {{ company.razao_social }}</p>
                    <p><strong>Nome Fantasia:</strong> {{ company.nome_fantasia }}</p>
                    <p><strong>CNPJ:</strong> {{ company.cnpj }}</p>
                    <p><strong>Inscrição Estadual:</strong> {{ company.inscricao_estadual|default:"Não informado" }}</p>
                    <p><strong>Contato Institucional:</strong> {{ company.institutional_contact|default:"Não informado" }}</p>
                    <p class="md:col-span-2"><strong>E-mail Institucional:</strong> {{ company.institutional_email|default:"Não informado" }}</p>
                    <p class="md:col-span-2"><strong>Endereço:</strong> {{ company.address|default:"Não informado" }}</p>
                    {% if company.logo %}<p><strong>Logotipo:</strong> <img src="{{ company.logo.url }}" alt="Logo" class="h-16 mt-2"></p>{% endif %}
                </div>
            </div>

            <!-- Atividades -->
            <div>
                <h3 class="text-xl font-semibold text-secondary border-b pb-2 mb-4">Atividades (CNAE)</h3>
                <p><strong>Atividade Principal:</strong> {{ company.main_activity }}</p>
                <p><strong>Atividades Secundárias:</strong></p>
                <ul class="list-disc list-inside ml-4">
                    {% for activity in company.secondary_activities.all %}
                        <li>{{ activity }}</li>
                    {% empty %}
                        <li>Nenhuma atividade secundária cadastrada.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Dados do Responsável -->
            <div>
                <h3 class="text-xl font-semibold text-secondary border-b pb-2 mb-4">Dados do Responsável Legal/Delegado</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p><strong>Nome Completo:</strong> {{ company.legal_rep_name }}</p>
                    <p><strong>Cargo/Função:</strong> {{ company.legal_rep_role }}</p>
                    <p><strong>Contato Direto/WhatsApp:</strong> {{ company.legal_rep_contact }}</p>
                    <p><strong>Email:</strong> {{ company.legal_rep_email }}</p>
                </div>
            </div>
        </div>

        <div class="mt-8 border-t pt-6">
            <h3 class="text-xl font-semibold text-secondary mb-4">Histórico de Solicitações</h3>
            {% for req in company.change_requests.all %}
                <div class="p-4 mb-2 border rounded-lg">
                    <p><strong>Data:</strong> {{ req.created_at|date:"d/m/Y H:i" }}</p>
                    <p><strong>Status:</strong> {{ req.get_status_display }}</p>
                </div>
            {% empty %}
                <p class="text-gray-500">Nenhuma solicitação de alteração encontrada.</p>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Garante que o script só rode se o formulário estiver na página
    if (document.getElementById('main_activity_search')) {
        const cnaeOptions = {{ cnae_options_json|safe }};
        
        const mainSearch = document.getElementById('main_activity_search');
        const mainResults = document.getElementById('main_activity_results');
        const mainHiddenInput = document.getElementById('id_main_activity');

        function setupCnaeSearch(searchInput, resultsContainer, onSelectCallback) {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                const filtered = cnaeOptions.filter(cnae => cnae.code.toLowerCase().includes(query) || cnae.description.toLowerCase().includes(query));
                resultsContainer.innerHTML = '';
                if (filtered.length > 0) {
                    filtered.slice(0, 50).forEach(cnae => {
                        const item = document.createElement('div');
                        item.className = 'cnae-item';
                        item.textContent = `${cnae.code} - ${cnae.description}`;
                        item.addEventListener('click', () => onSelectCallback(cnae));
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
        }

        setupCnaeSearch(mainSearch, mainResults, (cnae) => {
            mainHiddenInput.value = cnae.id;
            mainSearch.value = `${cnae.code} - ${cnae.description}`;
            mainResults.style.display = 'none';
        });

        const secondarySearch = document.getElementById('secondary_activities_search');
        const secondaryResults = document.getElementById('secondary_activities_results');
        const secondaryHiddenContainer = document.getElementById('secondary-hidden-inputs');
        const secondarySelectedContainer = document.getElementById('secondary_activities_selected');
        let selectedSecondaryIds = new Set();

        function renderSelectedSecondary() {
            secondarySelectedContainer.innerHTML = '';
            secondaryHiddenContainer.innerHTML = '';
            selectedSecondaryIds.forEach(id => {
                const cnae = cnaeOptions.find(opt => opt.id == id);
                if (cnae) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'selected-cnae';
                    itemEl.innerHTML = `<span class="truncate pr-2">${cnae.code} - ${cnae.description}</span><button type="button" class="ml-2 text-red-500 hover:text-red-700 font-bold" onclick="removeSecondary(${id})">&times;</button>`;
                    secondarySelectedContainer.appendChild(itemEl);
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'secondary_activities';
                    hiddenInput.value = id;
                    secondaryHiddenContainer.appendChild(hiddenInput);
                }
            });
        }

        window.removeSecondary = function(id) {
            selectedSecondaryIds.delete(id);
            renderSelectedSecondary();
        }

        setupCnaeSearch(secondarySearch, secondaryResults, (cnae) => {
            selectedSecondaryIds.add(cnae.id);
            renderSelectedSecondary();
            secondarySearch.value = '';
            secondaryResults.style.display = 'none';
        });
    }
</script>
{% endblock %}
